parameters:
  platform: ''
steps:

- task: MSBuild@1
  displayName: build
  inputs:
    solution: boots.sln
    msbuildArguments: '/restore /t:Build,Pack /bl:$(System.DefaultWorkingDirectory)/bin/boots.binlog'

- script: |
    dotnet vstest Boots.Tests/bin/$(Configuration)/netcoreapp3.0/Boots.Tests.dll --logger:"trx;verbosity=normal" --logger:"console;verbosity=normal"
  displayName: Run tests

- task: PublishTestResults@2
  displayName: publish test results
  inputs:
    testResultsFormat: VSTest
    testResultsFiles: TestResults/*.trx
    testRunTitle: ${{ parameters.platform }}
    failTaskOnFailedTests: true
  condition: succeededOrFailed()

- script: |
    echo "$(BinDirectory)"
    dotnet tool install -g dotnet-script
    dotnet script Boots.Script/main.csx --verbosity trace --no-cache -s $(BinDirectory)
  displayName: dotnet-script xamarin-android stable

- task: MSBuild@1
  displayName: verify
  inputs:
    solution: scripts/xa-version.targets
    msbuildArguments: '/v:minimal /nologo /t:Check /p:Expected=$(XA.StableVersion) /bl:$(System.DefaultWorkingDirectory)/bin/verify-stable.binlog'

- script: |
    dotnet Boots/bin/$(Configuration)/netcoreapp3.0/Boots.dll --preview Xamarin.Android
  displayName: boots xamarin-android preview

- task: MSBuild@1
  displayName: verify
  inputs:
    solution: scripts/xa-version.targets
    msbuildArguments: '/v:minimal /nologo /t:Check /p:Expected=$(XA.PreviewVersion) /bl:$(System.DefaultWorkingDirectory)/bin/verify-preview.binlog'

- task: MSBuild@1
  displayName: build sample
  inputs:
    solution: samples/HelloForms.Android/HelloForms.Android.csproj
    msbuildArguments: '/restore /t:SignAndroidPackage /p:AndroidPackageFormat=aab /bl:$(System.DefaultWorkingDirectory)/bin/sample.binlog'

- task: PublishPipelineArtifact@0
  displayName: artifacts
  inputs:
    artifactName: ${{ parameters.platform }}
    targetPath: bin
  condition: succeededOrFailed()
